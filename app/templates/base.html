{% from "components/nav_item.html" import nav_item %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>{% block title %}TaskFlow{% endblock %}</title>

  <!-- Tailwind (compiled) -->
  <link href="{{ url_for('static', filename='css/app.css') }}" rel="stylesheet"/>

  <!-- Alpine -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    html.dark { color-scheme: dark; }
    [x-cloak] { display:none !important; }
    aside.sidebar { will-change: width, transform; }
    .sidebar-transition {
      transition: width 0.22s cubic-bezier(.2,.9,.2,1),
                  padding 0.22s cubic-bezier(.2,.9,.2,1);
    }
    .sidebar-item { transition: background 0.18s ease, color 0.12s ease; }
    .sidebar-item:hover { background: rgba(148,163,184,0.08); }

    /* Dashboard cards */
    .glass-card {
      background: rgba(15,23,42,0.75);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(148,163,184,0.15);
    }
  </style>

  <script>
    // initial theme (we still support both, but default to dark)
    (function () {
      const stored = localStorage.getItem("theme");
      const prefersDark = window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      const useDark = stored ? stored === "dark" : prefersDark;
      document.documentElement.classList.toggle("dark", useDark);
    })();

    function toggleTheme() {
      const html = document.documentElement;
      const nowDark = !html.classList.contains("dark");
      html.classList.toggle("dark", nowDark);
      localStorage.setItem("theme", nowDark ? "dark" : "light");
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const el = document.getElementById("theme-icon");
      if (!el) return;
      const dark = document.documentElement.classList.contains("dark");
      el.setAttribute("data-lucide", dark ? "sun" : "moon");
      lucide.createIcons();
    }

    document.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();
      updateThemeIcon();
    });
  </script>
</head>
<body
  x-data="{ openSidebar: true, openTaskModal: false }"
  class="bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 overflow-x-hidden"
>
<div class="min-h-screen flex">

  <!-- SIDEBAR -->
  <aside
    class="sidebar sidebar-transition hidden md:flex md:flex-col bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800"
    :class="openSidebar ? 'w-64' : 'w-20'">

    <!-- logo + collapse -->
    <div class="flex items-center justify-between px-4 py-5 border-b border-slate-200 dark:border-slate-800">
      <a href="{{ url_for('dashboard.home') }}" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white font-semibold shadow-lg">
          TF
        </div>
        <div x-show="openSidebar" x-cloak>
          <p class="font-semibold text-lg leading-tight">TaskFlow</p>
        </div>
      </a>

      <button @click="openSidebar = !openSidebar"
              class="text-slate-500 dark:text-slate-300 hover:text-indigo-500 transition">
        <span x-show="openSidebar" x-cloak>←</span>
        <span x-show="!openSidebar" x-cloak>→</span>
      </button>
    </div>

    <!-- nav -->
    <nav class="flex-1 px-3 py-5 space-y-1">
      {{ nav_item("Dashboard", url_for("dashboard.home"), "layout-dashboard") }}
      {{ nav_item("Tasks", url_for("dashboard.tasks_page"), "check-square") }}
      {{ nav_item("Projects", url_for("dashboard.projects_page"), "folder") }}
      {{ nav_item("Analytics", url_for("dashboard.analytics_page"), "bar-chart-3") }}
      {{ nav_item("Settings", url_for("dashboard.settings_page"), "settings") }}
    </nav>

    <!-- user -->
    <div class="px-4 py-4 border-t border-slate-200 dark:border-slate-800 flex items-center gap-3">
      <div class="h-9 w-9 rounded-lg bg-slate-200 dark:bg-slate-700 flex items-center justify-center font-semibold text-slate-800 dark:text-white">
        {{ (current_user.email[0] if current_user.is_authenticated and current_user.email) or 'U' | upper }}
      </div>
      <div x-show="openSidebar" x-cloak class="min-w-0">
        <p class="text-sm font-medium truncate">{{ current_user.email }}</p>
        <p class="text-xs text-slate-500 dark:text-slate-400">Member since 2025</p>
      </div>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <div class="flex-1 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="sticky top-0 z-20 bg-white/80 dark:bg-slate-900/80 border-b border-slate-200 dark:border-slate-800 backdrop-blur">
      <div class="h-16 flex items-center justify-between px-4 sm:px-6 lg:px-8">

        <!-- left: page title -->
        <div class="flex items-center gap-3">
          <!-- mobile menu -->
          <button id="mobile-menu-btn"
                  class="md:hidden px-2 py-1 rounded-md text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800">
            ☰
          </button>
          <p class="text-lg sm:text-xl font-semibold">
            {% block header_title %}{% endblock %}
          </p>
        </div>

        <!-- right: theme toggle + logout -->
        <div class="flex items-center gap-3">
          <!-- Theme toggle -->
          <button id="theme-btn"
                  class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800"
                  onclick="toggleTheme()">
            <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
          </button>

          <!-- New Task (optional; visible on dashboard etc.) -->
          <button
            @click="openTaskModal = true"
            class="hidden sm:inline-flex px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm font-medium shadow hover:bg-indigo-500">
            + New Task
          </button>

          <!-- Logout (far right) -->
          <a href="{{ url_for('auth.logout') }}"
             class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
            Logout
          </a>
        </div>

      </div>
    </header>

    <!-- PAGE CONTENT -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl sm:text-4xl font-bold mb-2">
          {% block page_title %}{% endblock %}
        </h1>
        <p class="text-slate-500 dark:text-slate-400 mb-6">
          {% block page_subtitle %}{% endblock %}
        </p>

        {% block content %}{% endblock %}
      </div>
    </main>
  </div>
</div>

<!-- MOBILE DRAWER -->
<div id="mobile-drawer" class="fixed inset-0 z-40 md:hidden hidden">
  <div id="mobile-drawer-backdrop" class="absolute inset-0 bg-black/40"></div>
  <div class="absolute left-0 top-0 bottom-0 w-64 bg-white dark:bg-slate-900 p-4 shadow-lg">
    <nav class="space-y-1">
      {{ nav_item("Dashboard", url_for('dashboard.home'), "layout-dashboard") }}
      {{ nav_item("Tasks", url_for('dashboard.tasks_page'), "check-square") }}
      {{ nav_item("Projects", url_for('dashboard.projects_page'), "folder") }}
      {{ nav_item("Analytics", url_for('dashboard.analytics_page'), "bar-chart-3") }}
      {{ nav_item("Settings", url_for('dashboard.settings_page'), "settings") }}
    </nav>
  </div>
</div>

<script>
  // mobile drawer toggle
  (function () {
    const btn = document.getElementById("mobile-menu-btn");
    const drawer = document.getElementById("mobile-drawer");
    const backdrop = document.getElementById("mobile-drawer-backdrop");
    if (!btn || !drawer || !backdrop) return;
    btn.addEventListener("click", () => drawer.classList.remove("hidden"));
    backdrop.addEventListener("click", () => drawer.classList.add("hidden"));
  })();
</script>

<!-- NEW TASK MODAL -->
<div>
  <div x-show="openTaskModal"
       x-transition.opacity
       class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40"
       @click="openTaskModal=false"></div>

  <div x-show="openTaskModal"
       x-transition.scale.origin.center
       class="fixed inset-0 z-50 flex items-center justify-center px-4">
    <div @click.stop
         class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-xl shadow-2xl p-6 border border-slate-200 dark:border-slate-700">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">New Task</h2>
        <button @click="openTaskModal=false"
                class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
      </div>

      <form method="POST" action="{{ url_for('dashboard.task_create') }}" class="space-y-4">
        <div>
          <label class="text-sm font-medium">Title</label>
          <input name="title" required
                 class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900">
        </div>

        <div>
          <label class="text-sm font-medium">Description</label>
          <textarea name="description"
                    class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900"></textarea>
        </div>

        <div>
          <label class="text-sm font-medium">Due Date</label>
          <input type="date" name="due_date"
                 class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900">
        </div>

        <div class="flex justify-end gap-3 pt-4">
          <button type="button"
                  @click="openTaskModal=false"
                  class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700">
            Cancel
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-medium hover:bg-indigo-500 shadow">
            Create Task
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
</body>
</html>